<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Publicidad - Video YouTube</title>
  <style>
    body {
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: #000;
    }
    .hero {
      width: 100%;
      max-width: 600px;
      aspect-ratio: 9/16; /* Formato vertical 9:16 */
      background: #000;
      position: relative;
    }
    #videoHolder {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <!-- CONTENEDOR DEL VIDEO -->
  <div class="hero">
    <div id="videoHolder" data-video-id="EFe4-ab1lBo"></div>
  </div>

  <script>
    /* --------------------------
       CONFIG
       -------------------------- */
    const VIDEO_ID = document.querySelector('#videoHolder')?.dataset?.videoId || 'bCGGDeq6D3Y';
    const REDIRECT_URL = 'https://mapsx.app/publicidad';
    const FALLBACK_REDIRECT_AFTER = 25; // segundos de fallback si la API falla
    let player = null;
    let progressInterval = null;
    let fallbackTimer = null;
    let preventAutoRedirect = false;

    /* utility */
    function redirectNow(){
      window.location.href = REDIRECT_URL;
    }

    /* --------------------------
       LOAD YOUTUBE IFRAME API
       -------------------------- */
    function loadYouTubeApi(){
      return new Promise((resolve)=>{
        if(window.YT && window.YT.Player){
          resolve();
          return;
        }
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        tag.async = true;
        document.head.appendChild(tag);
        // global callback required by YT
        window.onYouTubeIframeAPIReady = function(){
          resolve();
        };
        // safety fallback in case the script fails to load quickly
        setTimeout(()=>resolve(), 5000);
      });
    }

    async function initPlayer(){
      await loadYouTubeApi();
      try{
        player = new YT.Player('videoHolder', {
          height: '100%',
          width: '100%',
          videoId: VIDEO_ID,
          playerVars: {
            autoplay: 1,
            controls: 0,
            mute: 1,
            rel: 0,
            playsinline: 1,
            modestbranding: 1,
            disablekb: 1,
            iv_load_policy: 3
          },
          events: {
            onStateChange: onPlayerStateChange,
            onError: onPlayerError
          }
        });
      }catch(e){
        console.warn('YT init error', e);
        startFallback();
      }

      // fallback: redirect si no carga en X tiempo
      fallbackTimer = setTimeout(()=>{
        if(!player && !preventAutoRedirect) startFallback();
      }, (FALLBACK_REDIRECT_AFTER * 1000));
    }

    function onPlayerStateChange(e){
      if(e.data === YT.PlayerState.ENDED){
        if(!preventAutoRedirect) redirectNow();
      }
      if(e.data === YT.PlayerState.PLAYING){
        clearTimeout(fallbackTimer);
      }
    }

    function onPlayerError(err){
      console.warn('YT player error', err);
      if(!preventAutoRedirect) setTimeout(()=>{ redirectNow(); }, 3000);
    }

    function startFallback(){
      if(!preventAutoRedirect) redirectNow();
    }

    // cleanup
    window.addEventListener('beforeunload', ()=>{
      if(progressInterval) clearInterval(progressInterval);
      if(fallbackTimer) clearTimeout(fallbackTimer);
    });

    /* INIT */
    initPlayer();
  </script>
</body>
</html>
